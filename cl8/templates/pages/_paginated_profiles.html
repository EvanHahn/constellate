{% load gravatar %}
<div class="active-tags w-4/5 mx-auto">
  {% if active_tags %}
    <h3>Active tags</h3>
    {% for active_tag in active_tags %}
      <span class="badge my-2 mx-1 p-4 hover:bg-red-900 hover:shadow-lg hover:cursor-pointer"
            data-tag-name="{{ active_tag.name }}"
            data-tag-id="{{ active_tag.tag.id }}">{{ active_tag.name }}</span>
    {% endfor %}
  {% endif %}
</div>
<div class="ml-4 pa-4 text-center">
  <p class="text-xl inline-block ">Showing {{ paginated_profiles|length }} profile{{ paginated_profiles|pluralize }}</p>
</div>
{% for profile in paginated_profiles %}
  <div class="card w-96 bg-base-100 mb-1">
    {% comment %} we want our whole div to be clickable {% endcomment %}
    <div class="card-body profile hover:bg-yellow-100 hover:shadow-lg hover:cursor-pointer"
         hx-get="{% url 'profile-detail' profile.short_id %}"
         hx-params="*"
         hx-target="#profile-slot"
         hx-push-url="true">
      <div class=profile-thumb>
        {% if profile.photo %}
          <img class="profile-thumb" src="{{ profile.thumbnail_photo }}" />
        {% else %}
          {% gravatar profile.user.email 150 %}
        {% endif %}
      </div>
      <div>
        <h4 class="card-title">
          <a href="{% url 'profile-detail' profile.short_id %}">{{ profile.name }}
            {% comment %} {{ profile.rank }} {% endcomment %}
          </a>
        </h4>
        <p>
          {% comment %}
            TODO: this is a source of n+1 queries, because run this once for each user
            and our prefetch query to fetch tags for a user doesn't work here.
            I think it's down to when we call flat_tag_list, as it triggers entirely 
            new queries on the profile object - Chris
          {% endcomment %}
          {% for tag in profile.tags_with_no_grouping|slice:":4" %}
            <span class="badge mx-1" data-tag-name="{{ tag.tag.name }}">{{ tag.name }}</span>
          {% endfor %}
        </p>
      </div>
    </div>
  </div>
{% endfor %}
<style>
.profile {
  flex-direction: row;  
}

.profile-thumb{
  flex-direction: row;
}

.profile-thumb img {
  width:50px;
}
</style>
<script>
  document.querySelectorAll('.active-tags .badge').forEach(item => {
    item.addEventListener('click', event => {
        const selectorString = `#id_tags option[value="${event.target.dataset.tagId}"]`
        const chosenTagOption = document.querySelector(selectorString)
        chosenTagOption.selected = !chosenTagOption.selected
        document.body.dispatchEvent(new Event("toggle-tag"))
    })
})
</script>
