# Installation

- Checkout the code and install dependencies
- Setup the project credentials
- Running it to test it out
- Deploying somewhere others can see it
- Changing the domain

## install the code and dependencies

First, you need to download the code and necessary software libraries:


```
git clone git@github.com:productscience/constellate.git
```

#### Install the dependencies

Once you have downloaded the main project `cd` into the web directory, and install the dependencies:

``` bash
cd cl8-web
npm install
```

If you don't have firebase installed, install it with:

```
npm firebase -g
```

#### - Setup the project credentials

Once you have the code and dependencies, sure you need to have a project set up with firebase, to make it work. This is free, but if you don't already have an account you need to create one

``` bash
firebase init
```

You want:

- hosting (so people can see your site)
- database (so data it can be saved somewhere)
- functions (to allow for importing users from airtable or google spreadsheets)

You'll be asked what you want as your public directory. We're using a tool, webpack to optimize the assets we serve, and we currently put them into the `dist` directory so choose `dist`, instead of `public`.

Now we have a new project the next step will be set up the necessary bits in the web UI, specifically:

- come up with a name for your project
- switching on username and password authentication
- downloading credentials

#### naming the project

Once you have decided a name for the project, you'll need to update it in a few places, so that password reset emails appear to come from the correct addresses, and the project name is the one you have chosen, and your users will recognise rather than an autogenerated project number. Update it at the general settings url:

https://console.firebase.google.com/project/YOUR_PROJECT_NAME/settings/general/

You may also want to update the password reset email text, at:

https://console.firebase.google.com/project/test-install-run/authentication/emails

#### Making sure people can sign in 

Finally, you'll want to allow people sign in with email, before you can proceed.

https://console.firebase.google.com/project/YOUR_PROJECT_NAME/authentication/providers

Remember, to make sure the password reset email message is correct here.

Congrats! First part sorted!

### Setting credentials

Once you have this, you'll need the credentials for either running a local version for development, for running deploys

#### Fetching the credentials from firebase:

go to project overview > project settings

click "Add firebase to your web app"

Copy the credentials to your clipboard and copy the two sample env files `.envs` files, so you have

```
.envs/dev.sh
.envs/prod.sh
```

Now, add the corresponding credentials these newly created env files, so for `FIREBASE_DATABASEURL_DEV` you'd add whatever was matched by the `databaseURL` in the project settings, and so on.

#### Fetching the service account for firebase

You'll likely want to be able to run admin commands, like importing the initial set of users, and so on. You can do this by downloading a service account key, from the admin section too.

Go to project overview > project settings > service accounts. 

You can also reach this at the link below:

https://console.firebase.google.com/project/test-install-run/settings/serviceaccounts/adminsdk

On the service accounts page, hit GENERATE NEW PRIVATE KEY and save the file in your project, in the `.envs` directory, with a name like `project-name-service-account.json`, so that if your project name was `trying-this-out`, your key would be called `trying-this-out-service-account.json`.

You'll need to add this to your env files, so adding a line like this below for `.envs/dev.sh`:

``` bash
export FIREBASE_SERVICE_ACCOUNT_PATH_DEV='trying-this-out-service-account.json'
```

And the same for the `.envs/prod.sh`:

``` bash
export FIREBASE_SERVICE_ACCOUNT_PATH_PROD='trying-this-out-service-account.json'
```

## Importing users

Now, when 

Before you can see anything you need to import users into firebase. The fastest way to do this is to run one of the admin scripts for importing users on your own machine.

Later on, you can trigger this import from a cloud function instead, if you want to regularly import users from an airtable.


```
source .envs/dev.sh
cd admin_scripts/
node ./importUsersAndTags.js
```

Depending how many users you have to import this will take a few minutes to run, as it loops through the users in airtable, and create firebase accounts for them, and builds a datastructure for the app to search through.

### Running locally

Once you have users imported, you can try running the constellate application locally - this will connect to the database hosted with google, that you just imported users to. Make sure you're in `cl8-web` then run:

```
npm start
```

This will spin up a development server, typically running locally on port 8080. you can visit it by visiting the address below in your browser:

http://localhost:8080 


### Deploying somewhere others can see it

Once you see it working, likely you'll want others to be able to see it too. You can deploy the app by calling the npm command below when in `cl8-web`.

```
npm run release
```
